---
env:
  global:
    # We use backticks in favor of the proper $() subshell call to cope with the
    # evaluation of Travis CI. Else we had trouble with the braces of the regex.
    # The regex matches on subdirectories only - identified by the trailing /.
    - TO_BUILD=`git diff --name-only $TRAVIS_COMMIT_RANGE HEAD | grep -oP '^.*?(?=\/)' | uniq | tr -s "\n" ":" || exit 0`

jobs:
  include:
    - &build_and_run
      stage: build and run images
      # Only run this job when there are changes in the subdir 'debirf'
      # Attention: Travis CI is only parsing this file if the condition is met.
      # before_install: git diff --name-only $TRAVIS_COMMIT_RANGE HEAD | grep -qP '^debirf/' && env
      before_install: env
      # Verbose if conditional instead  pure [[ ]] - else this won't work in this YAML file.
      # TODO: Check if TRAVIS_EVENT_TYPE is cron to trigger builds of daily cron jobs
      before_script:
        - |
          if ! [[ "$TO_BUILD" = *"debirf"* ]] || ! [[ "$TRAVIS_EVENT_TYPE" = "cron" ]] ; then
            exit 0
          fi
      env: KERNEL=4.15.0-45-generic SUITE=xenial
      dist: xenial
      sudo: required
      language: bash
      script: ./debirf/build_and_run_images
      after_success:
        - git config --global user.email "build@travis-ci.com"
        - git config --global user.name "Travis CI"
        - git tag -a "$(date +'%Y%m%d')" -m 'Automatic release by Travis CI'
        - git push "https://${TOKEN}@github.com/${TRAVIS_REPO_SLUG}".git --tags
        - git fetch origin
        - git tag
      deploy:
        provider: releases
        api_key: ${TOKEN}
        file_glob: true
        file: debirf/build/*
        skip_cleanup: true
        on:
          branch: master
        draft: false

    - <<: *build_and_run
      env: KERNEL=5.0.0-13-generic SUITE=disco

    - &run_coinboot
      stage: run coinboot
      before_script: if ! [[ "$TO_BUILD" = *"server"* ]]; then exit 0; fi
      env: KERNEL=4.15.0-45-generic SUITE=xenial
      dist: xenial
      sudo: required
      language: bash
      script: ./server/run_coinboot

      # - <<: *run_coinboot
      # env: KERNEL=4.15.0-45-generic SUITE=xenial

    - <<: *run_coinboot
      env: KERNEL=5.0.0-13-generic SUITE=disco
