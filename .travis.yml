---
env:
  global:
    # We can enforce builds even with no changes in ./debirf.
    - FORCE_BUILD=true
    # We use backticks in favor of the proper $() subshell call to cope with the
    # evaluation of Travis CI. Else we had trouble with the braces of the regex.
    # The regex matches on subdirectories only - identified by the trailing /.
    - TO_BUILD=`git diff --name-only $TRAVIS_COMMIT_RANGE | grep -oP '^.*?(?=\/)' | uniq | tr -s "\n" ":" || exit 0`
    - GITHUB_REPO=coinboot
    - GITHUB_USER=frzb
    - RELEASE_TAG=$(date +%Y%m%d)



jobs:
  if:  commit_message != 'Automatic release by Travis CI'
  include:
    - &build_and_run
      stage: build and run images
      env:
        - KERNEL=4.15.0-72-generic
        - SUITE=xenial
      # We can't set the job name via environment variables.
      # https://github.com/travis-ci/travis-ci/issues/9984
      name: xenial
      workspaces:
        create:
          name: xenial
          paths:
            - debirf/build/xenial/*
      # Only run this job when there are changes in the subdir 'debirf'
      # Attention: Travis CI is only parsing this file if the condition is met.
      # before_install: git diff --name-only $TRAVIS_COMMIT_RANGE HEAD | grep -qP '^debirf/' && env
      before_install: env
      # Verbose if conditional instead  pure [[ ]] - else this won't work in this YAML file.
      # TODO: Check if TRAVIS_EVENT_TYPE is cron to trigger builds of daily cron jobs
      before_script:
        - |
          if [[ $FORCE_BUILD = true ]]; then
              echo 'Forcing build - even if there are no changes in ./debirf'
          else
            if ! [[ "$TRAVIS_EVENT_TYPE" = "cron" ]] && ! [[ "$TO_BUILD" = *"debirf"* ]]; then
              exit 0
            fi
          fi
      dist: bionic
      language: bash
      script: ./debirf/build_and_run_images
      # Tag generation with 'date' comes with a newline to strip off.
      # Use 'printf' instead.

    - stage: pre-release
      workspaces:
        use:
          - eoan
          - xenial
      before_script:
        - go get github.com/aktau/github-release
        - github-release --version
        - ls -la ./debirf/*/*
      script:
        - github-release -v release --pre-release --tag ${TRAVIS_BUILD_ID} --name pre-release-${TRAVIS_BUILD_ID}
        - find ./debirf/build -name coinboot-* -type f -execdir sh -c "readlink -f {} && basename {}" \; | xargs -n 2 sh -c 'github-release -v upload --tag "${TRAVIS_BUILD_ID}" -n $2 -f $1 -l $2' sh
      before_deploy:
        - git config --global user.email "build@travis-ci.com"
        - git config --global user.name "Travis CI"
        - git tag -a "${TRAVIS_BUILD_ID}" -m 'Automatic release by Travis CI'

    - <<: *build_and_run
      env:
        - KERNEL=5.3.0-29-generic
        - SUITE=eoan
      name: eoan
      workspaces:
        create:
          name: eoan
          paths:
            - debirf/build/eoan/*

    - &run_coinboot
      stage: run coinboot
      env:
        - KERNEL=4.15.0-72-generic
        - SUITE=xenial
        - RELEASE=$TRAVIS_BUILD_ID
      workspaces:
        use:
          - xenial
      before_script:
        - |
          if [[ $FORCE_BUILD = true ]]; then
            echo 'Forcing build - even if there are no changes in ./debirf'
          else
            if ! [[ "$TRAVIS_EVENT_TYPE" = "cron" ]] && ! [[ "$TO_BUILD" = *"server"* ]]; then
              exit 0
            fi
          fi
      dist: bionic
      language: bash
      script: ./server/run_coinboot

      #- <<: *run_coinboot
      #  env: KERNEL=5.3.0-29-generic SUITE=eoan

    - stage: release
      if: branch = master
      before_script:
        - go get github.com/aktau/github-release
        - github-release --version
      script:
        - github-release -v edit --tag "${TRAVIS_BUILD_ID}" --name ${RELEASE_TAG}
        - github-release -v delete -t "${TRAVIS_BUILD_ID}"

    - stage: cleanup
      if: branch != master
      before_script:
        - go get github.com/aktau/github-release
        - github-release --version
      script:
        - github-release -v delete -t "${TRAVIS_BUILD_ID}"
